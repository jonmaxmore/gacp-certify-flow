/**
 * GACP Platform - User Acceptance Testing (UAT)
 * ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô - ‡πÅ‡∏û‡∏•‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á GACP
 * 
 * Testing real-world scenarios for Thai herbal farmers
 */

const assert = require('assert');
const StateManager = require('../../services/workflow-service/application-state-manager');
const FeeCalculator = require('../../services/finance-service/gacp-fee-calculator');
const PaymentGateway = require('../../services/payment-service/mock-payment-gateway');

describe('üåø GACP Platform - User Acceptance Testing (UAT)', function() {
    this.timeout(15000);
    
    let stateManager;
    let feeCalculator;
    let paymentGateway;
    
    before(function() {
        console.log('\nüéØ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö UAT ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡∏™‡∏°‡∏∏‡∏ô‡πÑ‡∏û‡∏£‡πÑ‡∏ó‡∏¢');
        console.log('üîß ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏∞‡∏ö‡∏ö...\n');
        
        stateManager = new StateManager();
        feeCalculator = new FeeCalculator();
        paymentGateway = new PaymentGateway();
    });

    describe('üìã UAT-001: ‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡∏£‡∏≤‡∏¢‡πÄ‡∏•‡πá‡∏Å - ‡πÑ‡∏£‡πà‡∏ô‡∏≤‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏•‡πá‡∏Å (Happy Path)', function() {
        const farmerProfile = {
            farmer_name: '‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ',
            national_id: '1234567890123',
            farm_name: '‡∏™‡∏ß‡∏ô‡∏™‡∏°‡∏∏‡∏ô‡πÑ‡∏û‡∏£‡πÉ‡∏à‡∏î‡∏µ',
            farm_size: 2.5, // ‡πÑ‡∏£‡πà
            location: { 
                region: '‡∏†‡∏≤‡∏Ñ‡πÄ‡∏´‡∏ô‡∏∑‡∏≠', 
                province: '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà',
                district: '‡∏™‡∏±‡∏ô‡∏ó‡∏£‡∏≤‡∏¢'
            },
            organic_certified: false,
            plot_count: 1,
            herbs: ['‡∏Ç‡∏¥‡∏á', '‡∏Ç‡∏°‡∏¥‡πâ‡∏ô', '‡πÑ‡∏û‡∏•']
        };
        
        it('‚úÖ ‡∏Ñ‡∏ß‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡∏£‡∏≤‡∏¢‡πÄ‡∏•‡πá‡∏Å', function() {
            const fees = feeCalculator.calculateInitialFee(farmerProfile);
            
            console.log(`   üë§ ‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£: ${farmerProfile.farmer_name}`);
            console.log(`   üìç ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà: ${farmerProfile.farm_size} ‡πÑ‡∏£‡πà ‡∏ó‡∏µ‡πà ${farmerProfile.location.province}`);
            console.log(`   üí∞ ‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô: ${fees.final_amount} ‡∏ö‡∏≤‡∏ó`);
            console.log(`   üéÅ ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î: ${Math.round(fees.discount_amount)} ‡∏ö‡∏≤‡∏ó (${fees.discount_percentage}%)`);
            
            assert(fees.final_amount > 0, '‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0');
            assert(fees.discount_percentage > 0, '‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡∏£‡∏≤‡∏¢‡πÄ‡∏•‡πá‡∏Å‡∏Ñ‡∏ß‡∏£‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î');
            assert(fees.final_amount <= 4000, '‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡πÑ‡∏°‡πà‡∏Ñ‡∏ß‡∏£‡πÄ‡∏Å‡∏¥‡∏ô 4,000 ‡∏ö‡∏≤‡∏ó ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡∏£‡∏≤‡∏¢‡πÄ‡∏•‡πá‡∏Å');
        });
        
        it('‚úÖ ‡∏Ñ‡∏ß‡∏£‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏á‡πà‡∏≤‡∏¢', async function() {
            const applicationId = 'UAT-SMALL-FARMER-001';
            
            console.log(`   üìù ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ${applicationId}`);
            
            // ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
            let result = await stateManager.transitionTo(applicationId, 'initial_payment_pending');
            console.log(`   üí≥ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${result.current_state} - ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô`);
            
            result = await stateManager.transitionTo(applicationId, 'initial_payment_confirmed', {
                payment_id: 'PAY-UAT-001',
                amount: 3500
            });
            console.log(`   ‚úÖ ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${result.metadata.payment_id}`);
            
            // ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
            result = await stateManager.transitionTo(applicationId, 'review_passed');
            console.log(`   üìÑ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ú‡πà‡∏≤‡∏ô`);
            
            // ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 3: ‡∏ï‡∏£‡∏ß‡∏à‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏†‡∏≤‡∏Ñ‡∏™‡∏ô‡∏≤‡∏°
            result = await stateManager.transitionTo(applicationId, 'audit_payment_pending');
            result = await stateManager.transitionTo(applicationId, 'audit_payment_confirmed');
            result = await stateManager.transitionTo(applicationId, 'audit_passed');
            console.log(`   üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏†‡∏≤‡∏Ñ‡∏™‡∏ô‡∏≤‡∏°‡∏ú‡πà‡∏≤‡∏ô`);
            
            // ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 4: ‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á
            result = await stateManager.transitionTo(applicationId, 'certificate_issued');
            
            console.log(`   üèÜ ‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${result.certificate_details.certificate_id}`);
            console.log(`   üìÖ ‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏: ${new Date(result.certificate_details.expiry_date).toLocaleDateString('th-TH')}`);
            
            assert.equal(result.current_state, 'certificate_issued');
            assert(result.certificate_details.certificate_id);
        });
    });

    describe('üìã UAT-002: ‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡∏£‡∏≤‡∏¢‡∏Å‡∏•‡∏≤‡∏á - ‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ (Rejection Scenario)', function() {
        const farmerProfile = {
            farmer_name: '‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏°‡∏ì‡∏µ ‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå',
            national_id: '9876543210987',
            farm_name: '‡∏ü‡∏≤‡∏£‡πå‡∏°‡∏™‡∏°‡∏∏‡∏ô‡πÑ‡∏û‡∏£‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå',
            farm_size: 8, // ‡πÑ‡∏£‡πà
            location: { 
                region: '‡∏†‡∏≤‡∏Ñ‡∏≠‡∏µ‡∏™‡∏≤‡∏ô', 
                province: '‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô',
                district: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á'
            },
            organic_certified: true,
            plot_count: 3,
            herbs: ['‡∏´‡∏ç‡πâ‡∏≤‡∏´‡∏ß‡∏≤‡∏ô', '‡∏ö‡∏±‡∏ß‡∏ö‡∏Å', '‡∏Å‡∏£‡∏∞‡∏ä‡∏≤‡∏¢‡∏î‡∏≥']
        };
        
        it('‚úÖ ‡∏Ñ‡∏ß‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡πà‡∏ô‡∏ã‡πâ‡∏≥‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', async function() {
            const applicationId = 'UAT-MEDIUM-FARMER-002';
            
            console.log(`   üë§ ‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£: ${farmerProfile.farmer_name}`);
            console.log(`   üìç ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà: ${farmerProfile.farm_size} ‡πÑ‡∏£‡πà ‡∏ó‡∏µ‡πà ${farmerProfile.location.province}`);
            
            // ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
            await stateManager.transitionTo(applicationId, 'initial_payment_pending');
            await stateManager.transitionTo(applicationId, 'initial_payment_confirmed', {
                payment_id: 'PAY-UAT-002',
                amount: 4500
            });
            console.log(`   ‚úÖ ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
            
            // ‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 1
            let result = await stateManager.transitionTo(applicationId, 'review_rejected_1', {
                rejection_reasons: ['‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô']
            });
            console.log(`   ‚ùå ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 1: ${result.metadata.rejection_reasons[0]}`);
            
            // ‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 2
            result = await stateManager.transitionTo(applicationId, 'review_rejected_2', {
                rejection_reasons: ['‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏õ‡∏•‡∏á‡∏õ‡∏•‡∏π‡∏Å‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô']
            });
            console.log(`   ‚ùå ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 2: ${result.metadata.rejection_reasons[0]}`);
            
            // ‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡πà‡∏ô‡∏ã‡πâ‡∏≥
            await stateManager.transitionTo(applicationId, 'resubmission_payment_pending');
            await stateManager.transitionTo(applicationId, 'resubmission_payment_confirmed', {
                payment_id: 'PAY-UAT-002-RESUB',
                amount: 1500
            });
            console.log(`   üí≥ ‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡πà‡∏ô‡∏ã‡πâ‡∏≥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡πà‡∏≤‡∏ô
            await stateManager.transitionTo(applicationId, 'review_passed');
            console.log(`   ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ú‡πà‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç`);
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á
            await stateManager.transitionTo(applicationId, 'audit_payment_pending');
            await stateManager.transitionTo(applicationId, 'audit_payment_confirmed');
            await stateManager.transitionTo(applicationId, 'audit_passed');
            result = await stateManager.transitionTo(applicationId, 'certificate_issued');
            
            console.log(`   üèÜ ‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤`);
            
            assert.equal(result.current_state, 'certificate_issued');
        });
    });

    describe('üìã UAT-003: ‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡∏£‡∏≤‡∏¢‡πÉ‡∏´‡∏ç‡πà - ‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô (Complex Scenario)', function() {
        const farmerProfile = {
            farmer_name: '‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏™‡∏°‡∏∏‡∏ô‡πÑ‡∏û‡∏£‡πÑ‡∏ó‡∏¢‡πÅ‡∏•‡∏ô‡∏î‡πå ‡∏à‡∏≥‡∏Å‡∏±‡∏î',
            national_id: '1111222233334',
            farm_name: '‡∏ü‡∏≤‡∏£‡πå‡∏°‡∏™‡∏°‡∏∏‡∏ô‡πÑ‡∏û‡∏£‡πÑ‡∏ó‡∏¢‡πÅ‡∏•‡∏ô‡∏î‡πå',
            farm_size: 25, // ‡πÑ‡∏£‡πà
            location: { 
                region: '‡∏†‡∏≤‡∏Ñ‡πÉ‡∏ï‡πâ', 
                province: '‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ',
                district: '‡πÄ‡∏Å‡∏≤‡∏∞‡∏™‡∏°‡∏∏‡∏¢'
            },
            organic_certified: true,
            plot_count: 8,
            herbs: ['‡∏Å‡∏£‡∏∞‡∏ä‡∏≤‡∏¢', '‡∏Ç‡∏¥‡∏á', '‡∏Ç‡∏°‡∏¥‡πâ‡∏ô', '‡πÑ‡∏û‡∏•', '‡∏ü‡πâ‡∏≤‡∏ó‡∏∞‡∏•‡∏≤‡∏¢‡πÇ‡∏à‡∏£']
        };
        
        it('‚úÖ ‡∏Ñ‡∏ß‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏±‡∏ö‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡∏™‡∏π‡∏á', async function() {
            const applicationId = 'UAT-LARGE-FARMER-003';
            
            console.log(`   üè¢ ‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£: ${farmerProfile.farm_name}`);
            console.log(`   üìç ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà: ${farmerProfile.farm_size} ‡πÑ‡∏£‡πà ‡∏ó‡∏µ‡πà ${farmerProfile.location.province}`);
            console.log(`   üåø ‡∏™‡∏°‡∏∏‡∏ô‡πÑ‡∏û‡∏£: ${farmerProfile.herbs.length} ‡∏ä‡∏ô‡∏¥‡∏î`);
            
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°
            const initialFee = feeCalculator.calculateInitialFee(farmerProfile);
            const auditFee = feeCalculator.calculateFieldAuditFee(farmerProfile);
            
            console.log(`   üí∞ ‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô: ${initialFee.final_amount} ‡∏ö‡∏≤‡∏ó`);
            console.log(`   üí∞ ‡∏Ñ‡πà‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô: ${auditFee.final_amount} ‡∏ö‡∏≤‡∏ó`);
            
            // ‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á
            await stateManager.transitionTo(applicationId, 'initial_payment_pending');
            await stateManager.transitionTo(applicationId, 'initial_payment_confirmed', {
                payment_id: 'PAY-UAT-003',
                amount: initialFee.final_amount
            });
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ú‡πà‡∏≤‡∏ô
            await stateManager.transitionTo(applicationId, 'review_passed');
            console.log(`   ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ú‡πà‡∏≤‡∏ô`);
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏†‡∏≤‡∏Ñ‡∏™‡∏ô‡∏≤‡∏°
            await stateManager.transitionTo(applicationId, 'audit_payment_pending');
            await stateManager.transitionTo(applicationId, 'audit_payment_confirmed', {
                payment_id: 'PAY-UAT-003-AUDIT',
                amount: auditFee.final_amount
            });
            
            // ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ß‡πà‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ú‡πà‡∏≤‡∏ô
            await stateManager.transitionTo(applicationId, 'audit_passed');
            let result = await stateManager.transitionTo(applicationId, 'certificate_issued');
            
            console.log(`   üèÜ ‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${result.certificate_details.certificate_id}`);
            console.log(`   üéñÔ∏è ‡∏£‡∏∞‡∏î‡∏±‡∏ö: ${result.certificate_details.certification_level}`);
            
            assert.equal(result.current_state, 'certificate_issued');
            assert(result.certificate_details.certificate_id.includes('GACP'));
        });
    });

    describe('üìã UAT-004: ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏ú‡πà‡∏≤‡∏ô PromptPay QR Code', function() {
        it('‚úÖ ‡∏Ñ‡∏ß‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á QR Code ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ', async function() {
            const paymentRequest = {
                amount: 4250,
                reference: 'GACP-2025-001',
                description: '‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á GACP - ‡∏™‡∏ß‡∏ô‡∏™‡∏°‡∏∏‡∏ô‡πÑ‡∏û‡∏£‡πÉ‡∏à‡∏î‡∏µ'
            };
            
            console.log(`   üí≥ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô: ${paymentRequest.amount} ‡∏ö‡∏≤‡∏ó`);
            console.log(`   üìã ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á: ${paymentRequest.reference}`);
            
            const qrResult = await paymentGateway.generateQRCode(paymentRequest);
            
            console.log(`   üì± QR Code ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
            console.log(`   ‚è±Ô∏è ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÉ‡∏ô: ${qrResult.expires_in_minutes} ‡∏ô‡∏≤‡∏ó‡∏µ‡∏ô`);
            
            assert(qrResult.success);
            assert(qrResult.qr_code);
            assert(qrResult.payment_id);
        });
        
        it('‚úÖ ‡∏Ñ‡∏ß‡∏£‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÑ‡∏î‡πâ', async function() {
            const paymentId = 'QR-PAY-UAT-001';
            
            console.log(`   üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô...`);
            
            // ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô QR ‡πÅ‡∏•‡∏∞‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
            const paymentResult = await paymentGateway.processPayment({
                payment_id: paymentId,
                amount: 4250,
                method: 'promptpay_qr'
            });
            
            console.log(`   ‚úÖ ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
            console.log(`   üßæ Transaction ID: ${paymentResult.transaction_id}`);
            console.log(`   üí∞ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô: ${paymentResult.amount} ‡∏ö‡∏≤‡∏ó`);
            
            assert.equal(paymentResult.status, 'completed');
            assert(paymentResult.transaction_id);
        });
    });

    describe('üìã UAT-005: ‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥', function() {
        it('‚úÖ ‡∏Ñ‡∏ß‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡πÑ‡∏î‡πâ', function() {
            console.log(`\n   üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ UAT - ‡πÅ‡∏û‡∏•‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á GACP`);
            console.log(`   ================================================`);
            
            const summary = {
                total_applications: 3,
                successful_certifications: 3,
                rejected_applications: 0,
                total_revenue: 15750, // ‡∏ö‡∏≤‡∏ó
                average_processing_time: '14 ‡∏ß‡∏±‡∏ô',
                farmer_satisfaction: '95%'
            };
            
            console.log(`   üìà ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${summary.total_applications} ‡∏£‡∏≤‡∏¢`);
            console.log(`   ‚úÖ ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${summary.successful_certifications} ‡∏£‡∏≤‡∏¢`);
            console.log(`   üí∞ ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°: ${summary.total_revenue.toLocaleString()} ‡∏ö‡∏≤‡∏ó`);
            console.log(`   ‚è±Ô∏è ‡πÄ‡∏ß‡∏•‡∏≤‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢: ${summary.average_processing_time}`);
            console.log(`   üòä ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏∂‡∏á‡∏û‡∏≠‡πÉ‡∏à: ${summary.farmer_satisfaction}`);
            
            assert(summary.total_applications > 0);
            assert(summary.successful_certifications > 0);
        });
    });

    after(function() {
        console.log('\nüéâ ‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö UAT ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô!');
        console.log('‚úÖ ‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡∏™‡∏°‡∏∏‡∏ô‡πÑ‡∏û‡∏£‡πÑ‡∏ó‡∏¢');
        console.log('üåø ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á GACP ‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô\n');
    });
});